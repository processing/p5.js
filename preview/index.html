<!DOCTYPE html>
<html>

<head>
  <title>P5 test</title>
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="cache-control" content="no-cache" />
  <meta charset="utf-8">

  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <script type="module">
    import p5 from '../src/app.js';
    import rendererWebGPU from '../src/webgpu/p5.RendererWebGPU.js';

    p5.registerAddon(rendererWebGPU);

    const sketch = function (p) {
      let fbo;
      let sh;
      let ssh;
      let tex;

      p.setup = async function () {
        await p.createCanvas(400, 400, p.WEBGPU);
        fbo = p.createFramebuffer();

        tex = p.createImage(100, 100);
        tex.loadPixels();
        for (let x = 0; x < tex.width; x++) {
          for (let y = 0; y < tex.height; y++) {
            const off = (x + y * tex.width) * 4;
            tex.pixels[off] = p.round((x / tex.width) * 255);
            tex.pixels[off + 1] = p.round((y / tex.height) * 255);
            tex.pixels[off + 2] = 0;
            tex.pixels[off + 3] = 255;
          }
        }
        tex.updatePixels();
        fbo.draw(() => {
          p.imageMode(p.CENTER);
          p.image(tex, 0, 0, p.width, p.height);
        });

        sh = p.baseMaterialShader().modify({
          uniforms: {
            'f32 time': () => p.millis(),
          },
          'Vertex getWorldInputs': `(inputs: Vertex) {
            var result = inputs;
            result.position.y += 40.0 * sin(uniforms.time * 0.005);
            return result;
          }`,
        })
	/*ssh = p.baseStrokeShader().modify({
          uniforms: {
            'f32 time': () => p.millis(),
          },
          'StrokeVertex getWorldInputs': `(inputs: StrokeVertex) {
            var result = inputs;
            result.position.y += 40.0 * sin(uniforms.time * 0.005);
            return result;
          }`,
	})*/
      };

      p.draw = function () {
        p.orbitControl();
        const t = p.millis() * 0.002;
        p.background(200);
        p.shader(sh);
        // p.strokeShader(ssh)
        p.ambientLight(150);
        p.directionalLight(100, 100, 100, 0, 1, -1);
        p.pointLight(155, 155, 155, 0, -200, 500);
        p.specularMaterial(255);
        p.shininess(300);
        //p.stroke('white');
        p.noStroke();
        for (const [i, c] of ['red', 'lime', 'blue'].entries()) {
          p.push();
          p.fill(c);
          p.translate(
            p.width/3 * p.sin(t + i * Math.E),
            0, //p.width/3 * p.sin(t * 0.9 + i * Math.E + 0.2),
            p.width/3 * p.sin(t * 1.2 + i * Math.E + 0.3),
          )
          p.texture(fbo)
          p.sphere(30);
          p.pop();
        }
      };
    };

    new p5(sketch);
  </script>
</body>

</html>
